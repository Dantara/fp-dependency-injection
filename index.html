<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Dependency injection</title>
<meta name="author" content="Nikita Aleshchenko"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js/dist/reveal.css"/>

<link rel="stylesheet" href="styles/tinkoff.css" id="theme"/>

<link rel="stylesheet" href="styles/extra.css"/>
<link rel="stylesheet" href="styles/monokai.css"/>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide" data-background="rgb(255, 221, 45)" data-state="title-slide">
<img src="images/logo.svg" id="title-img">
<h2 class="title">Dependency injection</h2>
<h3 class="subtitle">in functional programming</h3>
<h6 class="author">Nikita Aleshchenko</h6>
</section>
<section class="about-slide" data-background-color="#757C8D" style="height: 600px;">
  <div class="block">
    <div id="about-column">
      <img src="images/logo-yel.svg">
      <img id="about-travel-img" src="images/travel.png">
    </div>
    <div id="about-block">
      <img src="images/me.png">

      <p>Никита Алещенко | Haskell разработчик</p>

      <div id="about-contacts">
        <div class="about-contacts-line">
          <img src="images/at.svg">
          <p>n.aleshchenko@tinkoff.ru</p>
        </div>
        <div class="about-contacts-line">
          <img src="images/gh.png">
          <p>Dantara</p>
        </div>
      </div>
    </div>
  </div>
</section>

<section>
<section id="slide-org776e81c">
<h2 id="org776e81c">As software engeneers we want&#x2026;</h2>

</section>
</section>
<section>
<section id="slide-orgfe1eb50">
<h2 id="orgfe1eb50">Dependency injection</h2>
<div class="outline-text-2" id="text-orgfe1eb50">
</div>
</section>
<section id="slide-orge5763e1">
<h3 id="orge5763e1">Dependecy injection</h3>
<p>
Dependency Injection is a software design technique in which the creation and binding of dependencies are done outside of the dependent class.
</p>

</section>
<section id="slide-orgb9ae234">
<h3 id="orgb9ae234">Benefits of DI</h3>
<ul>
<li>Testability</li>
<li>Separation of concerns</li>

</ul>

</section>
<section id="slide-orge0b67a1">
<h3 id="orge0b67a1">Onion architecture</h3>
<span class="first-circle circle"></span>
<span class="second-circle circle"></span>
<span class="third-circle circle"></span>
</section>
<section id="slide-org18415aa">
<h3 id="org18415aa">Three layers cake</h3>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Layer №</th>
<th scope="col" class="org-left">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">3</td>
<td class="org-left">Business logic</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">DSL for Business logic</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">Interpreter</td>
</tr>
</tbody>
</table>

</section>
</section>
<section>
<section id="slide-org2d65352">
<h2 id="org2d65352">Sample project</h2>
<div class="outline-text-2" id="text-org2d65352">
</div>
</section>
<section id="slide-org0df148b">
<h3 id="org0df148b">Translator bot</h3>
<p>
Получает сообщение от пользователя через long polling, переводит с английского на русский, отправляет сообщение обратно пользователю.
</p>

<ul>
<li>Получение новых сообщений;</li>
<li>Отправка сообщений;</li>
<li>Перевод текста;</li>

</ul>
</section>
<section id="slide-orge7b6d6c">
<h3 id="orge7b6d6c">Gist</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Message = Msg
  { chatId :: Integer
  , text :: Text
  }

pullUpdates :: IO [Message]
pullUpdates = ...

sendMessage :: IO ()
sendMessage = ...

translate :: Text -&gt; IO (Maybe Text)
translate = ...

proceed :: IO ()
proceed = pullUpdates
  &gt;&gt;= traverse_ (translateMsg &gt;&gt;= sendMessage)
  where
    translateMsg :: Message -&gt; IO Message
    translateMsg (Msg ci t) = translate t
      &lt;&amp;&gt; (maybe
             (Msg ci "Cannot translate text")
             (Msg ci))

</code></pre>
</div>

</section>
<section id="slide-org9412f55">
<h3 id="org9412f55">Problems</h3>
<ul>
<li>Весь код в IO;</li>
<li>Не тестируемый код;</li>

</ul>

</section>
</section>
<section>
<section id="slide-org2d26baf">
<h2 id="org2d26baf">Handle / Service pattern</h2>
<div class="outline-text-2" id="text-org2d26baf">
</div>
</section>
<section id="slide-orga210212">
<h3 id="orga210212">Functional programming</h3>
<ul>
<li>Functions</li>
<li>Data</li>

</ul>
</section>
<section id="slide-orga13c089">
<h3 id="orga13c089">Key idea</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Handle = Handle
    { hPool   :: Pool Postgres.Connection
    , hCache  :: IORef (PSQueue Int Text User)
    , hLogger :: Logger.Handle  -- Another handle!
    , ...
    }
</code></pre>
</div>
</section>
<section id="slide-orgdf4eee1">
<h3 id="orgdf4eee1">Handle interface</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Handle = Handle
    { createUser :: Text -&gt; IO User
    , ...
    }
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >createUser :: Handle -&gt; Text -&gt; IO User
createUser = ...
</code></pre>
</div>

</section>
<section id="slide-org2ffe604">
<h3 id="org2ffe604">Our project</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Message = Msg
  { chatId :: Integer
  , text :: Text
  }

pullUpdates :: IO [Message]
pullUpdates = ...

sendMessage :: IO ()
sendMessage = ...

translate :: Text -&gt; IO (Maybe Text)
translate = ...

proceed :: IO ()
proceed = pullUpdates
  &gt;&gt;= traverse_ (translateMsg &gt;&gt;= sendMessage)
  where
    translateMsg :: Message -&gt; IO Message
    translateMsg (Msg ci t) = translate t
      &lt;&amp;&gt; (maybe
             (Msg ci "Cannot translate text")
             (Msg ci))

</code></pre>
</div>

</section>
<section id="slide-org2ed5905">
<h3 id="org2ed5905">Our project</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Handle = Handle
  { pullUpdates :: IO [Message]
  , sendMessage :: IO ()
  , translate :: Text -&gt; IO (Maybe Text)
  }

proceed :: Handle -&gt; IO ()
proceed h = pullUpdates h
  &gt;&gt;= traverse_ (translateMsg &gt;&gt;= sendMessage h)
  where
    translateMsg :: Message -&gt; m Message
    translateMsg (Msg ci t) = translate h t
      &lt;&amp;&gt; (maybe
             (Msg ci "Cannot translate text")
             (Msg ci))

</code></pre>
</div>

</section>
<section id="slide-org6082437">
<h3 id="org6082437">Parametrize monad</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Handle m = Handle
    { createUser :: Text -&gt; m User
    , getUserMail :: User -&gt; m [Mail]
    , ...
    }
</code></pre>
</div>

</section>
<section id="slide-orgcb51590">
<h3 id="orgcb51590">Our project</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Handle m = Handle
  { pullUpdates :: m [Message]
  , sendMessage :: m ()
  , translate :: Text -&gt; m (Maybe Text)
  }

proceed :: MonadIO m =&gt; Handle m -&gt; m ()
proceed h = pullUpdates h
  &gt;&gt;= traverse_ (translateMsg &gt;&gt;= sendMessage h)
  where
    translateMsg :: Message -&gt; m Message
    translateMsg (Msg ci t) = translate h t
      &lt;&amp;&gt; (maybe
             (Msg ci "Cannot translate text")
             (Msg ci))

</code></pre>
</div>

</section>
<section id="slide-org343de20">
<h3 id="org343de20">Pros &amp; Cons</h3>
<div class="outline-text-3" id="text-org343de20">
</div>
</section>
<section id="slide-org69edc9b">
<h4 id="org69edc9b">Pros:</h4>
<ul>
<li>Simple &amp; intuitive</li>
<li>Performant</li>
<li>Local substituation of a handlers</li>

</ul>

</section>
<section id="slide-orgf15b27c">
<h4 id="orgf15b27c">Cons:</h4>
<ul>
<li>Manual passing of handlers</li>
<li>Tightly bound to execution monad</li>

</ul>

</section>
</section>
<section>
<section id="slide-org60532ce">
<h2 id="org60532ce">Tagless final</h2>
<div class="outline-text-2" id="text-org60532ce">
</div>
</section>
<section id="slide-org4f168aa">
<h3 id="org4f168aa">Key idea</h3>
<p>
From <b>Handle</b> data structure to <b>Type classes</b>!
</p>
<div class="org-src-container">

<pre><code class="haskell" >data Handle m = Handle
  { pullUpdates :: m [Message]
  , sendMessage :: m ()
  , translate :: Text -&gt; m (Maybe Text)
  }
</code></pre>
</div>

<div id="orgf4337f0" class="figure">
<p><img src="./images/ArrowDown.png" alt="ArrowDown.png" width="5%" style="margin: -15px;" />
</p>
</div>
<div class="org-src-container">

<pre><code class="haskell" >class Monad m =&gt; MonadMessenger m where
  pullUpdates :: m [Message]
  sendMessage :: m ()
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >class Monad m =&gt; MonadTranslator m where
  translate :: Text -&gt; m (Maybe Text)
</code></pre>
</div>
</section>
<section id="slide-org658e728">
<h3 id="org658e728">Type families</h3>
<div class="org-src-container">

<pre><code class="haskell" >class Monad m =&gt; MonadMessenger m where
  type Message m :: *
  pullUpdates :: m [Message]
  sendMessage :: m ()
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >class Monad m =&gt; MonadTranslator m where
  translate :: Text -&gt; m (Maybe Text)
</code></pre>
</div>

</section>
<section id="slide-org0b137e8">
<h3 id="org0b137e8">Our project</h3>
<div class="org-src-container">

<pre><code class="haskell" >class Monad m =&gt; MonadMessenger m where
  pullUpdates :: m [Message]
  sendMessage :: m ()

class Monad m =&gt; MonadTranslator m where
  translate :: Text -&gt; m (Maybe Text)

proceed :: (MonadMessenger m, MonadTranslator m) =&gt; m ()
proceed h = pullUpdates
  &gt;&gt;= traverse_ (translateMsg &gt;&gt;= sendMessage)
  where
    translateMsg :: (MonadTranslator m) =&gt; Message -&gt; m Message
    translateMsg (Msg ci t) = translate t
      &lt;&amp;&gt; (maybe
             (Msg ci "Cannot translate text")
             (Msg ci))

</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org183e434">
<h2 id="org183e434">Free monads</h2>
<div class="outline-text-2" id="text-org183e434">
</div>
</section>
<section id="slide-org4910ecf">
<h3 id="org4910ecf">Big Three</h3>
<p>
<b>Functor</b>
</p>
<div class="org-src-container">

<pre><code class="haskell" >class Functor f where
  fmap :: (a -&gt; b) -&gt; f a -&gt; f b
</code></pre>
</div>

<p>
<b>Applicative</b>
</p>
<div class="org-src-container">

<pre><code class="haskell" >class Functor f =&gt; Applicative f where
  pure :: a -&gt; f a
  (&lt;*&gt;) :: f (a -&gt; b) -&gt; f a -&gt; f b
</code></pre>
</div>

<p>
<b>Monad</b>
</p>
<div class="org-src-container">

<pre><code class="haskell" >class Applicative m =&gt; Monad m where
  return :: a -&gt; m a
  (&gt;&gt;=) :: m a -&gt; (a -&gt; m b) -&gt; m b
</code></pre>
</div>

</section>
<section id="slide-org3e52b1e">
<h3 id="org3e52b1e">Monad</h3>
<div class="org-src-container">

<pre><code class="haskell" >class Applicative m =&gt; Monad m where
  return :: a -&gt; m a
  (&gt;&gt;=) :: m a -&gt; (a -&gt; m b) -&gt; m b
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >join :: (Monad m) =&gt; m (m a) -&gt; m a
</code></pre>
</div>

</section>
<section id="slide-org31f3c92">
<h3 id="org31f3c92">Monad</h3>
<div class="org-src-container">

<pre><code class="haskell" >join :: (Monad m) =&gt; m (m a) -&gt; m a
fmap :: (a -&gt; b) -&gt; f a -&gt; f b
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >(&gt;&gt;=) :: m a -&gt; (a -&gt; m b) -&gt; m b
(&gt;&gt;=) m f = join (fmap f m)
</code></pre>
</div>

</section>
<section id="slide-orgb332656">
<h3 id="orgb332656">Key Idea</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Free f a
  = Pure a
  | Free (f (Free f a))
</code></pre>
</div>

</section>
<section id="slide-org0365d38">
<h3 id="org0365d38">Key Idea</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Free f a
  = Pure a
  | Free (f (Free f a))
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >Pure :: a -&gt; m a        -- looks like pure
Free :: f (m a) -&gt; m a  -- looks like join
</code></pre>
</div>

</section>
<section id="slide-org8d64454">
<h3 id="org8d64454">Functor instance</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Free f a
  = Pure a
  | Free (f (Free f a))
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >instance Functor f =&gt; Functor (Free f) where
  fmap g (Free fx) = Free (fmap g &lt;$&gt; fx)
  fmap g (Pure x)  = Pure (g x)
</code></pre>
</div>

</section>
<section id="slide-org548c3c4">
<h3 id="org548c3c4">Monad instance</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Free f a
  = Pure a
  | Free (f (Free f a))
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >instance Functor f =&gt; Monad (Free f) where
  return = Pure
  Pure x  &gt;&gt;= g  =  g x
  Free fx &gt;&gt;= g  =  Free ((&gt;&gt;= g) &lt;$&gt; fx)
</code></pre>
</div>

</section>
<section id="slide-org62476e3">
<h3 id="org62476e3">Business logic functor</h3>
<div class="org-src-container">

<pre><code class="haskell" >data BotF
  = PullUpdates [Message]
  | SendMessage Message
  | Translate Text (Maybe Text)
</code></pre>
</div>

</section>
<section id="slide-org73b9ae9">
<h3 id="org73b9ae9">Business logic functor</h3>
<div class="org-src-container">

<pre><code class="haskell" >data BotF a
  = PullUpdates [Message] a
  | SendMessage Message a
  | Translate Text (Maybe Text) a
</code></pre>
</div>

</section>
<section id="slide-orga797a7d">
<h3 id="orga797a7d">Business logic functor</h3>
<div class="org-src-container">

<pre><code class="haskell" >data BotF a
  = PullUpdates ([Message] -&gt; a)
  | SendMessage Message a
  | Translate Text ((Maybe Text) -&gt; a)
</code></pre>
</div>

</section>
<section id="slide-orgc5cc818">
<h3 id="orgc5cc818">Business logic functor</h3>
<div class="org-src-container">

<pre><code class="haskell" >data BotF a
  = PullUpdates ([Message] -&gt; a)
  | SendMessage Message a
  | Translate Text ((Maybe Text) -&gt; a)
  deriving (Functor)

type Bot = Free BotF
</code></pre>
</div>

</section>
<section id="slide-orgff39533">
<h3 id="orgff39533">Lift functor</h3>
<div class="org-src-container">

<pre><code class="haskell" >liftF :: Functor f =&gt; f a -&gt; Free f a
liftF command = Free (fmap Pure command)
</code></pre>
</div>


</section>
<section id="slide-org5248705">
<h3 id="org5248705">Helper functions</h3>
<div class="org-src-container">

<pre><code class="haskell" >data BotF a
  = PullUpdates ([Message] -&gt; a)
  | SendMessage Message a
  | Translate Text ((Maybe Text) -&gt; a)
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >pullUpdates :: Bot [Message]
pullUpdates = liftF (PullUpdates id)

sendMessage :: Message -&gt; Bot ()
sendMessage msg = liftF (SendMessage msg ())

translate :: Text -&gt; Bot (Maybe Text)
translate t = liftF (Translate t id)
</code></pre>
</div>

</section>
<section id="slide-orgb4fbe1d">
<h3 id="orgb4fbe1d">Business logic</h3>
<div class="org-src-container">

<pre><code class="haskell" >proceed :: Bot ()
proceed h = pullUpdates
  &gt;&gt;= traverse_ (translateMsg &gt;&gt;= sendMessage)
  where
    translateMsg :: Message -&gt; Bot Message
    translateMsg (Msg ci t) = translate t
      &lt;&amp;&gt; (maybe
             (Msg ci "Cannot translate text")
             (Msg ci))
</code></pre>
</div>

</section>
<section id="slide-org080ce9a">
<h3 id="org080ce9a">Interpreter</h3>
<div class="org-src-container">

<pre><code class="haskell" >botIO :: BotF a -&gt; IO a
botIO (PullUpdates u) = ...
botIO (SendMessage m a) = ...
botIO (Translate t ft) = ...
</code></pre>
</div>

</section>
<section id="slide-org3647b15">
<h3 id="org3647b15">Interpreter helpers</h3>
<div class="org-src-container">

<pre><code class="haskell" >freeM :: (Functor f, Functor g)
      =&gt; (f a -&gt; g a) -&gt; Free f a -&gt; Free g a
freeM phi (Pure x) = Pure x
freeM phi (Free fx) = Free $ phi (freeM phi &lt;$&gt; fx)
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >monad :: Monad m =&gt; Free m a -&gt; m a
monad (Pure x) = pure x
monad (Free mfx) = do
  fx &lt;- mfx
  monad fx
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >interp :: (Functor f, Monad m)
       =&gt; (f a -&gt; m a) -&gt; Free f a -&gt; m a
interp phi = monad . freeM phi
</code></pre>
</div>

</section>
<section id="slide-org33e4c86">
<h3 id="org33e4c86">Interpreter</h3>
<div class="org-src-container">

<pre><code class="haskell" >botIO :: BotF a -&gt; IO a
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >interp :: (Functor f, Monad m)
       =&gt; (f a -&gt; m a) -&gt; Free f a -&gt; m a
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >interpBotIO :: Bot a -&gt; IO a
interpBotIO = interp botIO
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org2251a51">
<h2 id="org2251a51">Freer monads</h2>
<div class="outline-text-2" id="text-org2251a51">
</div>
</section>
<section id="slide-org111f725">
<h3 id="org111f725">Free monad</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Free f a
  = Pure a
  | Free (f (Free f a))
</code></pre>
</div>

<div id="org1feaf5b" class="figure">
<p><img src="./images/ArrowDown.png" alt="ArrowDown.png" width="5%" style="margin: -15px;" />
</p>
</div>
<div class="org-src-container">

<pre><code class="haskell" >data Free f a where
  Pure   :: a -&gt; Free f a
  Impure :: f (Free f a) -&gt; Free f a
</code></pre>
</div>
</section>
<section id="slide-orgc2587b0">
<h3 id="orgc2587b0">Simple trick</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Lan g a where
  Lan :: g x -&gt; (x -&gt; a) -&gt; Lan g a

instance Functor (Lan g) where
  fmap f (Lan gx h) = Lan gx (f . h)

lan :: g a -&gt; Lan g a
lan ga = Lan ga id
</code></pre>
</div>
</section>
<section id="slide-org11a6ef1">
<h3 id="org11a6ef1">Substitution</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Free f a where
  Pure   :: a -&gt; Free f a
  Impure :: f (Free f a) -&gt; Free f a
</code></pre>
</div>


<div id="org810d1ab" class="figure">
<p><img src="./images/ArrowDown.png" alt="ArrowDown.png" width="5%" style="margin: -15px;" />
</p>
</div>
<div class="org-src-container">

<pre><code class="haskell" >data Free (Lan g a) a where
  Pure   :: a -&gt; Free (Lan g a) a
  Impure :: (Lan (Free (Lan g a) a) a) -&gt; Free (Lan g a) a
</code></pre>
</div>


<div id="org0d6c701" class="figure">
<p><img src="./images/ArrowDown.png" alt="ArrowDown.png" width="5%" style="margin: -15px;" />
</p>
</div>
<div class="org-src-container">

<pre><code class="haskell" >data FFree g a where
  FPure   :: a -&gt; FFree g a
  FImpure :: g x -&gt; (x -&gt; FFree g a) -&gt; FFree g a
</code></pre>
</div>
</section>
</section>
<section>
<section id="slide-org2386221">
<h2 id="org2386221">Effects systems</h2>
</section>
</section>
<section>
<section id="slide-orgcecc016">
<h2 id="orgcecc016">Questions?</h2>
</section>
</section>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/reveal.js/dist/reveal.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js/plugin/highlight/highlight.js"></script>
<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: false,
center: true,
slideNumber: 'c',
rollingLinks: false,
keyboard: true,
mouseWheel: false,
fragmentInURL: false,
hashOneBasedIndex: false,
pdfSeparateFragments: true,
overview: true,
width: 1075,
margin: 0.00,

transition: 'slide',
transitionSpeed: 'default',

// Plugins with reveal.js 4.x
plugins: [ RevealHighlight ],

// Optional libraries used to extend reveal.js
dependencies: [
]

});
</script>
</body>
</html>
