<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Dependency injection</title>
<meta name="author" content="Nikita Aleshchenko"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js/dist/reveal.css"/>

<link rel="stylesheet" href="styles/tinkoff.css" id="theme"/>

<link rel="stylesheet" href="styles/extra.css"/>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<link rel="stylesheet" href="styles/monokai.css"/>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide" data-background="rgb(255, 221, 45)" data-state="title-slide">
<img src="images/logo.svg" id="title-img">
<h2 class="title">Dependency injection</h2>
<h3 class="subtitle">in functional programming</h3>
<h6 class="author">Nikita Aleshchenko</h6>
</section>
<section class="about-slide" data-background-color="#757C8D" style="height: 600px;">
  <div class="block">
    <div id="about-column">
      <img src="images/logo-yel.svg">
      <img id="about-travel-img" src="images/travel.png">
    </div>
    <div id="about-block">
      <img src="images/me.png">

      <p>–ù–∏–∫–∏—Ç–∞ –ê–ª–µ—â–µ–Ω–∫–æ | Haskell —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫</p>

      <div id="about-contacts">
        <div class="about-contacts-line">
          <img src="images/at.svg">
          <p>n.aleshchenko@tinkoff.ru</p>
        </div>
        <div class="about-contacts-line">
          <img src="images/gh.png">
          <p>Dantara</p>
        </div>
      </div>
    </div>
  </div>
</section>

<section>
<section id="slide-orgc8a23d9" data-auto-animate>
<h2 id="orgc8a23d9">–ú—ã –∫–∞–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ö–æ—Ç–∏–º –ø–∏—Å–∞—Ç—å&#x2026;</h2>
</section>
</section>
<section>
<section id="slide-org8355f2e" data-auto-animate>
<h2 id="org8355f2e">–ú—ã –∫–∞–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ö–æ—Ç–∏–º –ø–∏—Å–∞—Ç—å&#x2026;</h2>
<ul class="fragment appear">
<li>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –∫–æ–¥;</li>

</ul>
<ul class="fragment appear">
<li>–†–∞—Å—à–∏—Ä—è–µ–º—ã–π –∫–æ–¥;</li>

</ul>
<ul class="fragment appear">
<li>–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–¥;</li>

</ul>
<ul class="fragment appear">
<li>–¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–π –∫–æ–¥;</li>

</ul>

</section>
</section>
<section>
<section id="slide-orga59718a" data-auto-animate>
<h2 id="orga59718a">Dependency injection</h2>
</section>
</section>
<section>
<section id="slide-org7ccd723" data-auto-animate>
<h2 id="org7ccd723">Dependency injection</h2>
<p>
Dependency Injection (–í–Ω–µ–¥—Ä–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π) - —ç—Ç–æ –º–µ—Ç–æ–¥ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –ø—Ä–∏–≤—è–∑–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ–≥–æ –∫–ª–∞—Å—Å–∞.
</p>

</section>
<section id="slide-org7693fd5">
<h3 id="org7693fd5">–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ DI</h3>
<ul class="fragment appear">
<li>Separation of concerns (–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–µ–π);
<ul>
<li>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –∫–æ–¥;</li>
<li>–†–∞—Å—à–∏—Ä—è–µ–º—ã–π –∫–æ–¥;</li>
<li>–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–¥;</li>

</ul></li>

</ul>
<ul class="fragment appear">
<li>–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å;</li>

</ul>


</section>
</section>
<section>
<section id="slide-orgb63e64e" data-auto-animate>
<h2 id="orgb63e64e">Onion architecture</h2>
<span class="first-circle circle"></span>
<span class="second-circle circle"></span>
<span class="third-circle circle"></span>

</section>
</section>
<section>
<section id="slide-org29b5205" data-auto-animate>
<h2 id="org29b5205">Onion architecture</h2>
<span class="first-circle circle"></span>
<span class="second-circle circle"></span>
<span class="third-circle circle green-border"></span>

</section>
</section>
<section>
<section id="slide-org92d7296" data-auto-animate>
<h2 id="org92d7296">Onion architecture</h2>
<span class="first-circle circle red-border"></span>
<span class="second-circle circle"></span>
<span class="third-circle circle"></span>


</section>
<section id="slide-org868cd4c">
<h3 id="org868cd4c">–¢—Ä–µ—Ö —Å–ª–æ–π–Ω—ã–π –ø–∏—Ä–æ–≥</h3>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">‚Ññ</th>
<th scope="col" class="org-left">–°–ª–æ–π</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">3</td>
<td class="org-left">–ë–∏–∑–Ω–µ—Å –ª–æ–≥–∏–∫–∞</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">DSL –¥–ª—è –±–∏–∑–Ω–µ—Å –ª–æ–≥–∏–∫–∏</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä</td>
</tr>
</tbody>
</table>

</section>
</section>
<section>
<section id="slide-org7a89298">
<h2 id="org7a89298">–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h2>
<div class="outline-text-2" id="text-org7a89298">
</div>
</section>
<section id="slide-orgbcce0b8">
<h3 id="orgbcce0b8">–ë–æ—Ç –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫</h3>
<p>
–ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ long polling, –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–∏–π, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
</p>

<ul>
<li>–ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π;</li>
<li>–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π;</li>
<li>–ü–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞;</li>

</ul>
</section>
<section id="slide-org5e109f4">
<h3 id="org5e109f4">Gist</h3>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers='1-23|1-4|6-7|9-10|12-13|15|16|17|19|20|21-32'>data Message = Msg
  { chatId :: Integer
  , text   :: Text
  }

pullUpdates :: IO [Message]
pullUpdates = ...

sendMessage :: IO ()
sendMessage = ...

translate :: Text -&gt; IO (Maybe Text)
translate = ...

proceed :: IO ()
proceed = pullUpdates
  &gt;&gt;= traverse_ (translateMsg &gt;=&gt; sendMessage)
  where
    translateMsg :: Message -&gt; IO Message
    translateMsg (Msg ci t) = translate t
      &lt;&amp;&gt; (maybe
             (Msg ci "Cannot translate text")
             (Msg ci))
</code></pre>
</div>

</section>
<section id="slide-org431b58c">
<h3 id="org431b58c">–ü—Ä–æ–±–ª–µ–º—ã</h3>
<ul>
<li>–í–µ—Å—å –∫–æ–¥ –≤ IO; üöÄ</li>
<li>–ù–µ —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã–π –∫–æ–¥;</li>

</ul>

</section>
</section>
<section>
<section id="slide-orgaea84ad">
<h2 id="orgaea84ad">Handle / Service pattern</h2>
<div class="outline-text-2" id="text-orgaea84ad">
</div>
</section>
<section id="slide-org63e597e">
<h3 id="org63e597e">–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
<ul>
<li>–§—É–Ω–∫—Ü–∏–∏;</li>
<li>–î–∞–Ω–Ω—ã–µ;</li>

</ul>
</section>
<section id="slide-orgfcfd36f">
<h3 id="orgfcfd36f">–û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Handle = Handle
    { hPool   :: Pool Postgres.Connection
    , hCache  :: IORef (PSQueue Int Text User)
    , hLogger :: Logger.Handle  -- Another handle!
    , ...
    }
</code></pre>
</div>
</section>
<section id="slide-org2b5e80c">
<h3 id="org2b5e80c">Handle interface</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Handle = Handle
    { createUser :: Text -&gt; IO User
    , ...
    }
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >createUser :: Handle -&gt; Text -&gt; IO User
createUser = ...
</code></pre>
</div>

</section>
<section id="slide-orga6a5ed2" data-auto-animate>
<h3 id="orga6a5ed2">–ù–∞—à –ø—Ä–æ–µ–∫—Ç</h3>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers='1-18|1-8'>pullUpdates :: IO [Message]
pullUpdates = ...

sendMessage :: IO ()
sendMessage = ...

translate :: Text -&gt; IO (Maybe Text)
translate = ...

proceed :: IO ()
proceed = pullUpdates
  &gt;&gt;= traverse_ (translateMsg &gt;=&gt; sendMessage)
  where
    translateMsg :: Message -&gt; IO Message
    translateMsg (Msg ci t) = translate t
      &lt;&amp;&gt; (maybe
             (Msg ci "Cannot translate text")
             (Msg ci))
</code></pre>
</div>

</section>
<section id="slide-orgd844634" data-auto-animate>
<h3 id="orgd844634">–ù–∞—à –ø—Ä–æ–µ–∫—Ç</h3>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers>pullUpdates :: IO [Message]
pullUpdates = ...

sendMessage :: IO ()
sendMessage = ...

translate :: Text -&gt; IO (Maybe Text)
translate = ...
</code></pre>
</div>

</section>
<section id="slide-org6e317c6" data-auto-animate>
<h3 id="org6e317c6">–ù–∞—à –ø—Ä–æ–µ–∫—Ç</h3>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers>data Handle = Handle
  { pullUpdates :: IO [Message]
  , sendMessage :: IO ()
  , translate   :: Text -&gt; IO (Maybe Text)
  }
</code></pre>
</div>

</section>
<section id="slide-org8bd9aed" data-auto-animate>
<h3 id="org8bd9aed">–ù–∞—à –ø—Ä–æ–µ–∫—Ç</h3>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers='1-5|1-16|7-16'>data Handle = Handle
  { pullUpdates :: IO [Message]
  , sendMessage :: IO ()
  , translate   :: Text -&gt; IO (Maybe Text)
  }

proceed :: Handle -&gt; IO ()
proceed h = pullUpdates h
  &gt;&gt;= traverse_ (translateMsg &gt;=&gt; sendMessage h)
  where
    translateMsg :: Message -&gt; m Message
    translateMsg (Msg ci t) = translate h t
      &lt;&amp;&gt; (maybe
             (Msg ci "Cannot translate text")
             (Msg ci))

</code></pre>
</div>

</section>
<section id="slide-orgb512de1" data-auto-animate>
<h3 id="orgb512de1">–ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑—É–µ–º –º–æ–Ω–∞–¥—É</h3>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers>data Handle = Handle
  { pullUpdates :: IO [Message]
  , sendMessage :: IO ()
  , translate   :: Text -&gt; IO (Maybe Text)
  }
</code></pre>
</div>

</section>
<section id="slide-orgb138211" data-auto-animate>
<h3 id="orgb138211">–ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑—É–µ–º –º–æ–Ω–∞–¥—É</h3>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers>data Handle m = Handle
  { pullUpdates :: m [Message]
  , sendMessage :: m ()
  , translate   :: Text -&gt; m (Maybe Text)
  }
</code></pre>
</div>

</section>
<section id="slide-orgef51343" data-auto-animate>
<h3 id="orgef51343">–ù–∞—à –ø—Ä–æ–µ–∫—Ç</h3>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers='1-16|7'>data Handle m = Handle
  { pullUpdates :: m [Message]
  , sendMessage :: m ()
  , translate   :: Text -&gt; m (Maybe Text)
  }

proceed :: MonadIO m =&gt; Handle m -&gt; m ()
proceed h = pullUpdates h
  &gt;&gt;= traverse_ (translateMsg &gt;=&gt; sendMessage h)
  where
    translateMsg :: Message -&gt; m Message
    translateMsg (Msg ci t) = translate h t
      &lt;&amp;&gt; (maybe
             (Msg ci "Cannot translate text")
             (Msg ci))

</code></pre>
</div>

</section>
<section id="slide-org118fcb3">
<h3 id="org118fcb3">–ü–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã</h3>
<div class="outline-text-3" id="text-org118fcb3">
</div>
</section>
<section id="slide-org05fca69">
<h4 id="org05fca69">–ü–ª—é—Å—ã:</h4>
<ul>
<li>–ü—Ä–æ—Å—Ç–æ &amp; –ò–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ;</li>
<li>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ;</li>
<li>–ü–æ–¥–º–µ–Ω–∞ —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤ –≤ —Ä–∞–Ω—Ç–∞–π–º–µ;</li>

</ul>

</section>
<section id="slide-org40c628c">
<h4 id="org40c628c">–ú–∏–Ω—É—Å—ã:</h4>
<ul>
<li>–†—É—á–Ω–æ–µ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–Ω–∏–µ —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤;</li>
<li>–ü—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª–Ω—è—é—â–µ–π –º–æ–Ω–∞–¥–µ;</li>

</ul>

</section>
</section>
<section>
<section id="slide-org6998ef1">
<h2 id="org6998ef1">Tagless final</h2>
<div class="outline-text-2" id="text-org6998ef1">
</div>
</section>
<section id="slide-orgf32db00" data-auto-animate>
<h3 id="orgf32db00">–û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è</h3>
</section>
<section id="slide-orgc32b901" data-auto-animate>
<h3 id="orgc32b901">–û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è</h3>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers>data Handle m = Handle
  { pullUpdates :: m [Message]
  , sendMessage :: m ()
  , translate   :: Text -&gt; m (Maybe Text)
  }
</code></pre>
</div>

</section>
<section id="slide-orga3449d8" data-auto-animate>
<h3 id="orga3449d8">–û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è</h3>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers>class Monad m =&gt; MonadMessenger m where
  pullUpdates :: m [Message]
  sendMessage :: m ()

class Monad m =&gt; MonadTranslator m where
  translate :: Text -&gt; m (Maybe Text)
</code></pre>
</div>

</section>
<section id="slide-org5381d2a" data-auto-animate>
<h3 id="org5381d2a">–û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è</h3>
<p>
–ü–µ—Ä–µ—Ö–æ–¥ –æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã <b>Handle</b> –∫ <b>Type class</b>&rsquo;–∞–º!
</p>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers='1-6|1-3|5-6'>class Monad m =&gt; MonadMessenger m where
  pullUpdates :: m [Message]
  sendMessage :: m ()

class Monad m =&gt; MonadTranslator m where
  translate :: Text -&gt; m (Maybe Text)
</code></pre>
</div>

</section>
<section id="slide-orgb43f0be" data-auto-animate>
<h3 id="orgb43f0be">Type families</h3>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers='1-7|2'>class Monad m =&gt; MonadMessenger m where
  type Message m :: *
  pullUpdates :: m [Message]
  sendMessage :: m ()

class Monad m =&gt; MonadTranslator m where
  translate :: Text -&gt; m (Maybe Text)
</code></pre>
</div>

</section>
<section id="slide-org30428ea" data-auto-animate>
<h3 id="org30428ea">–ù–∞—à –ø—Ä–æ–µ–∫—Ç</h3>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers='1-16|8'>class Monad m =&gt; MonadMessenger m where
  pullUpdates :: m [Message]
  sendMessage :: m ()

class Monad m =&gt; MonadTranslator m where
  translate :: Text -&gt; m (Maybe Text)

proceed :: (MonadMessenger m, MonadTranslator m) =&gt; m ()
proceed = pullUpdates
  &gt;&gt;= traverse_ (translateMsg &gt;=&gt; sendMessage)
  where
    translateMsg :: (MonadTranslator m) =&gt; Message -&gt; m Message
    translateMsg (Msg ci t) = translate t
      &lt;&amp;&gt; (maybe
             (Msg ci "Cannot translate text")
             (Msg ci))
</code></pre>
</div>

</section>
<section id="slide-org4105e7d">
<h3 id="org4105e7d">–¢—É—Ç –±—É–¥–µ—Ç –µ—â—ë –ø–∞—á–∫–∞ —Å–ª–∞–π–¥–æ–≤</h3>

</section>
</section>
<section>
<section id="slide-orgbc2e83c">
<h2 id="orgbc2e83c">Free monads</h2>
<div class="outline-text-2" id="text-orgbc2e83c">
</div>
</section>
<section id="slide-orgd530a0f">
<h3 id="orgd530a0f">–ò–Ω—Ç–µ—Ä–ø—Ä–∏—Ç–∏—Ä—É–µ–º—ã–µ —è–∑—ã–∫–∏</h3>
<p>
–¢—É—Ç –±—É–¥—É—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏
</p>

</section>
<section id="slide-orgcd572dd" data-auto-animate>
<h3 id="orgcd572dd">–ë–æ–ª—å—à–∞—è —Ç—Ä–æ–∏—Ü–∞</h3>
<p>
<b>Functor</b>
</p>
<div class="org-src-container">

<pre><code class="haskell" >class Functor f where
  fmap :: (a -&gt; b) -&gt; f a -&gt; f b
</code></pre>
</div>

<p>
<b>Applicative</b>
</p>
<div class="org-src-container">

<pre><code class="haskell" >class Functor f =&gt; Applicative f where
  pure :: a -&gt; f a
  (&lt;*&gt;) :: f (a -&gt; b) -&gt; f a -&gt; f b
</code></pre>
</div>

<p>
<b>Monad</b>
</p>
<div class="org-src-container">

<pre><code class="haskell" >class Applicative m =&gt; Monad m where
  return :: a -&gt; m a
  (&gt;&gt;=) :: m a -&gt; (a -&gt; m b) -&gt; m b
</code></pre>
</div>

</section>
<section id="slide-org66b9db6">
<h3 id="org66b9db6">Functor</h3>
<div class="org-src-container">

<pre><code class="haskell" >class Functor f where
  fmap :: (a -&gt; b) -&gt; f a -&gt; f b
</code></pre>
</div>

</section>
<section id="slide-orgbc59737">
<h3 id="orgbc59737">Applicative</h3>
<div class="org-src-container">

<pre><code class="haskell" >class Functor f =&gt; Applicative f where
  pure :: a -&gt; f a
  (&lt;*&gt;) :: f (a -&gt; b) -&gt; f a -&gt; f b
</code></pre>
</div>

</section>
<section id="slide-org410dae9">
<h3 id="org410dae9">Monad</h3>
<div class="org-src-container">

<pre><code class="haskell" >class Applicative m =&gt; Monad m where
  return :: a -&gt; m a
  (&gt;&gt;=) :: m a -&gt; (a -&gt; m b) -&gt; m b
</code></pre>
</div>

</section>
<section id="slide-org0689a6c">
<h3 id="org0689a6c">Monad</h3>
<div class="org-src-container">

<pre><code class="haskell" >class Applicative m =&gt; Monad m where
  return :: a -&gt; m a
  (&gt;&gt;=) :: m a -&gt; (a -&gt; m b) -&gt; m b
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >join :: (Monad m) =&gt; m (m a) -&gt; m a
</code></pre>
</div>

</section>
<section id="slide-org6b6c08a">
<h3 id="org6b6c08a">Monad</h3>
<div class="org-src-container">

<pre><code class="haskell" >join :: (Monad m) =&gt; m (m a) -&gt; m a
fmap :: (a -&gt; b) -&gt; f a -&gt; f b
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >(&gt;&gt;=) :: m a -&gt; (a -&gt; m b) -&gt; m b
(&gt;&gt;=) m f = join (fmap f m)
</code></pre>
</div>

</section>
<section id="slide-org8500d7a">
<h3 id="org8500d7a">Key Idea</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Free f a
  = Pure a
  | Free (f (Free f a))
</code></pre>
</div>

</section>
<section id="slide-org0f11356">
<h3 id="org0f11356">Key Idea</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Free f a
  = Pure a
  | Free (f (Free f a))
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >Pure :: a -&gt; m a        -- looks like pure
Free :: f (m a) -&gt; m a  -- looks like join
</code></pre>
</div>

</section>
<section id="slide-org1309519">
<h3 id="org1309519">Functor instance</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Free f a
  = Pure a
  | Free (f (Free f a))
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >instance Functor f =&gt; Functor (Free f) where
  fmap g (Free fx) = Free (fmap g &lt;$&gt; fx)
  fmap g (Pure x)  = Pure (g x)
</code></pre>
</div>

</section>
<section id="slide-org0941c60">
<h3 id="org0941c60">Monad instance</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Free f a
  = Pure a
  | Free (f (Free f a))
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >instance Functor f =&gt; Monad (Free f) where
  return = Pure
  Pure x  &gt;&gt;= g  =  g x
  Free fx &gt;&gt;= g  =  Free ((&gt;&gt;= g) &lt;$&gt; fx)
</code></pre>
</div>

</section>
<section id="slide-orgdf34b2a">
<h3 id="orgdf34b2a">Business logic functor</h3>
<div class="org-src-container">

<pre><code class="haskell" >data BotF
  = PullUpdates [Message]
  | SendMessage Message
  | Translate Text (Maybe Text)
</code></pre>
</div>

</section>
<section id="slide-org316346c">
<h3 id="org316346c">Business logic functor</h3>
<div class="org-src-container">

<pre><code class="haskell" >data BotF a
  = PullUpdates [Message] a
  | SendMessage Message a
  | Translate Text (Maybe Text) a
</code></pre>
</div>

</section>
<section id="slide-org965819a">
<h3 id="org965819a">Business logic functor</h3>
<div class="org-src-container">

<pre><code class="haskell" >data BotF a
  = PullUpdates ([Message] -&gt; a)
  | SendMessage Message a
  | Translate Text ((Maybe Text) -&gt; a)
</code></pre>
</div>

</section>
<section id="slide-org4e6c0ca">
<h3 id="org4e6c0ca">Business logic functor</h3>
<div class="org-src-container">

<pre><code class="haskell" >data BotF a
  = PullUpdates ([Message] -&gt; a)
  | SendMessage Message a
  | Translate Text ((Maybe Text) -&gt; a)
  deriving (Functor)

type Bot = Free BotF
</code></pre>
</div>

</section>
<section id="slide-orge36cd21">
<h3 id="orge36cd21">Lift functor</h3>
<div class="org-src-container">

<pre><code class="haskell" >liftF :: Functor f =&gt; f a -&gt; Free f a
liftF command = Free (fmap Pure command)
</code></pre>
</div>


</section>
<section id="slide-org710fce7">
<h3 id="org710fce7">Helper functions</h3>
<div class="org-src-container">

<pre><code class="haskell" >data BotF a
  = PullUpdates ([Message] -&gt; a)
  | SendMessage Message a
  | Translate Text ((Maybe Text) -&gt; a)
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >pullUpdates :: Bot [Message]
pullUpdates = liftF (PullUpdates id)

sendMessage :: Message -&gt; Bot ()
sendMessage msg = liftF (SendMessage msg ())

translate :: Text -&gt; Bot (Maybe Text)
translate t = liftF (Translate t id)
</code></pre>
</div>

</section>
<section id="slide-org6fa2fc4">
<h3 id="org6fa2fc4">Business logic</h3>
<div class="org-src-container">

<pre><code class="haskell" >proceed :: Bot ()
proceed h = pullUpdates
  &gt;&gt;= traverse_ (translateMsg &gt;&gt;= sendMessage)
  where
    translateMsg :: Message -&gt; Bot Message
    translateMsg (Msg ci t) = translate t
      &lt;&amp;&gt; (maybe
             (Msg ci "Cannot translate text")
             (Msg ci))
</code></pre>
</div>

</section>
<section id="slide-org3fd0212">
<h3 id="org3fd0212">Interpreter</h3>
<div class="org-src-container">

<pre><code class="haskell" >botIO :: BotF a -&gt; IO a
botIO (PullUpdates u) = ...
botIO (SendMessage m a) = ...
botIO (Translate t ft) = ...
</code></pre>
</div>

</section>
<section id="slide-org6da1bd1">
<h3 id="org6da1bd1">Interpreter helpers</h3>
<div class="org-src-container">

<pre><code class="haskell" >freeM :: (Functor f, Functor g)
      =&gt; (f a -&gt; g a) -&gt; Free f a -&gt; Free g a
freeM phi (Pure x) = Pure x
freeM phi (Free fx) = Free $ phi (freeM phi &lt;$&gt; fx)
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >monad :: Monad m =&gt; Free m a -&gt; m a
monad (Pure x) = pure x
monad (Free mfx) = do
  fx &lt;- mfx
  monad fx
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >interp :: (Functor f, Monad m)
       =&gt; (f a -&gt; m a) -&gt; Free f a -&gt; m a
interp phi = monad . freeM phi
</code></pre>
</div>

</section>
<section id="slide-org9750623">
<h3 id="org9750623">Interpreter</h3>
<div class="org-src-container">

<pre><code class="haskell" >botIO :: BotF a -&gt; IO a
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >interp :: (Functor f, Monad m)
       =&gt; (f a -&gt; m a) -&gt; Free f a -&gt; m a
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >interpBotIO :: Bot a -&gt; IO a
interpBotIO = interp botIO
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-orgda5afa9">
<h2 id="orgda5afa9">Freer monads</h2>
<div class="outline-text-2" id="text-orgda5afa9">
</div>
</section>
<section id="slide-orgb6e5660" data-auto-animate>
<h3 id="orgb6e5660">Generilized Algebraic Data Types (GADT)</h3>
</section>
<section id="slide-orgebe52e9" data-auto-animate>
<h3 id="orgebe52e9">Generilized Algebraic Data Types (GADT)</h3>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers>data SomeType a
  = First a
  | Second a
</code></pre>
</div>

</section>
<section id="slide-org49a1e60" data-auto-animate>
<h3 id="org49a1e60">Generilized Algebraic Data Types (GADT)</h3>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers>data SomeType a where
  First  :: a -&gt; SomeType a
  Second :: a -&gt; SomeType a
</code></pre>
</div>

</section>
<section id="slide-org1d82bb9" data-auto-animate>
<h3 id="org1d82bb9">Generilized Algebraic Data Types (GADT)</h3>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers>data SomeType a where
  First  :: a -&gt; SomeType a
  Second :: Int -&gt; SomeType Int
</code></pre>
</div>

</section>
<section id="slide-orgfeb2b5d" data-auto-animate>
<h3 id="orgfeb2b5d">Generilized Algebraic Data Types (GADT)</h3>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers>data SomeType a where
  First  :: b -&gt; SomeType b
  Second :: Int -&gt; SomeType Int
</code></pre>
</div>

</section>
<section id="slide-org3c3a03b" data-auto-animate>
<h3 id="org3c3a03b">Free monad</h3>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers>data Free f a
  = Pure a
  | Free (f (Free f a))
</code></pre>
</div>
</section>
<section id="slide-org2a6a950" data-auto-animate>
<h3 id="org2a6a950">Free monad</h3>
<div class="org-src-container">

<pre><code class="haskell" data-line-numbers>data Free f a where
  Pure   :: a -&gt; Free f a
  Impure :: f (Free f a) -&gt; Free f a
</code></pre>
</div>
</section>
<section id="slide-orgdfeb8aa">
<h3 id="orgdfeb8aa">Simple trick</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Lan g a where
  Lan :: g x -&gt; (x -&gt; a) -&gt; Lan g a

instance Functor (Lan g) where
  fmap f (Lan gx h) = Lan gx (f . h)

lan :: g a -&gt; Lan g a
lan ga = Lan ga id
</code></pre>
</div>
</section>
<section id="slide-orgaa81531">
<h3 id="orgaa81531">Substitution</h3>
<div class="org-src-container">

<pre><code class="haskell" >data Free f a where
  Pure   :: a -&gt; Free f a
  Impure :: f (Free f a) -&gt; Free f a
</code></pre>
</div>


<div id="orgb6d734a" class="figure">
<p><img src="./images/ArrowDown.png" alt="ArrowDown.png" width="5%" style="margin: -15px;" />
</p>
</div>
<div class="org-src-container">

<pre><code class="haskell" >data Free (Lan g a) a where
  Pure   :: a -&gt; Free (Lan g a) a
  Impure :: (Lan (Free (Lan g a) a) a) -&gt; Free (Lan g a) a
</code></pre>
</div>


<div id="org5426bb6" class="figure">
<p><img src="./images/ArrowDown.png" alt="ArrowDown.png" width="5%" style="margin: -15px;" />
</p>
</div>
<div class="org-src-container">

<pre><code class="haskell" >data FFree g a where
  FPure   :: a -&gt; FFree g a
  FImpure :: g x -&gt; (x -&gt; FFree g a) -&gt; FFree g a
</code></pre>
</div>
</section>
</section>
<section>
<section id="slide-org7309377">
<h2 id="org7309377">Effects systems</h2>
</section>
</section>
<section>
<section id="slide-org31081a7">
<h2 id="org31081a7">Questions?</h2>
</section>
</section>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/reveal.js/dist/reveal.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js/plugin/highlight/highlight.js"></script>
<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: false,
center: true,
slideNumber: 'c',
rollingLinks: false,
keyboard: true,
mouseWheel: false,
fragmentInURL: false,
hashOneBasedIndex: false,
pdfSeparateFragments: true,
overview: true,
width: 1075,
margin: 0.00,

transition: 'slide',
transitionSpeed: 'default',

// Plugins with reveal.js 4.x
plugins: [ RevealHighlight ],

// Optional libraries used to extend reveal.js
dependencies: [
]

});
</script>
</body>
</html>
